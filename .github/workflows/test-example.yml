name: Test Django Guest User Example

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.9, "3.10", "3.11", "3.12"]
        django-version: [4.2, 5.0, 5.1]
        exclude:
          # Django 5.0+ requires Python 3.10+
          - python-version: 3.9
            django-version: 5.0
          - python-version: 3.9
            django-version: 5.1

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install Django==${{ matrix.django-version }}
        pip install django-allauth pytest pytest-django requests-oauthlib

    - name: Run Django checks
      run: |
        python manage.py check

    - name: Run migrations
      run: |
        python manage.py makemigrations
        python manage.py migrate

    - name: Test Django development server startup
      run: |
        timeout 10s python manage.py runserver || true
        echo "Development server can start successfully"

  test-example:
    runs-on: ubuntu-latest
    needs: test
    # Only run example tests after basic tests pass

    env:
      BASE_URL: http://127.0.0.1:8000
      SECRET_KEY: ${{ secrets.DJANGO_SECRET_KEY || 'django-insecure-test-example-key-not-for-production-12345' }}
      DEBUG: 'True'
      # Enable detailed Django logging
      DJANGO_LOG_LEVEL: 'DEBUG'

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Set up Node.js for Playwright
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install Django==5.1
        pip install django-allauth pytest pytest-django requests-oauthlib
        pip install playwright

    - name: Install Playwright browsers
      run: |
        playwright install --with-deps chromium

    - name: Create Django settings with enhanced logging
      run: |
        cat >> test_proj/settings_debug.py << 'EOF'
        # Import all settings from the original settings file
        from .settings import *
        import os

        # Override DEBUG setting
        DEBUG = True

        # Add STATIC_ROOT for collectstatic to work
        STATIC_ROOT = os.path.join(BASE_DIR, 'staticfiles')
        
        # Allow all hosts for testing
        ALLOWED_HOSTS = ['*']

        # Enhanced logging configuration for example project
        LOGGING = {
            'version': 1,
            'disable_existing_loggers': False,
            'formatters': {
                'verbose': {
                    'format': '{levelname} {asctime} {module} {process:d} {thread:d} {message}',
                    'style': '{',
                },
                'simple': {
                    'format': '{levelname} {message}',
                    'style': '{',
                },
            },
            'handlers': {
                'file': {
                    'level': 'DEBUG',
                    'class': 'logging.FileHandler',
                    'filename': '../django_debug.log',
                    'formatter': 'verbose',
                },
                'console': {
                    'level': 'DEBUG',
                    'class': 'logging.StreamHandler',
                    'formatter': 'verbose',
                },
            },
            'root': {
                'handlers': ['file', 'console'],
                'level': 'INFO',
            },
            'loggers': {
                'django': {
                    'handlers': ['file', 'console'],
                    'level': 'DEBUG',
                    'propagate': False,
                },
                'django.request': {
                    'handlers': ['file', 'console'],
                    'level': 'DEBUG',
                    'propagate': False,
                },
                'django.server': {
                    'handlers': ['file', 'console'],
                    'level': 'DEBUG',
                    'propagate': False,
                },
                'guest_user': {
                    'handlers': ['file', 'console'],
                    'level': 'DEBUG',
                    'propagate': False,
                },
            },
        }

        # Use environment variables for sensitive settings
        SECRET_KEY = os.environ.get('SECRET_KEY', SECRET_KEY)
        EOF

    - name: Prepare Django project
      run: |
        echo "=== Running Django migrations ==="
        python manage.py migrate --settings=test_proj.settings_debug
        
        echo "=== Collecting static files ==="
        python manage.py collectstatic --noinput --settings=test_proj.settings_debug

    - name: Create test superuser
      run: |
        echo "from django.contrib.auth import get_user_model; User = get_user_model(); \
        User.objects.filter(username='testuser').exists() or \
        User.objects.create_superuser('testuser', 'test@example.com', 'testpassword123')" \
        | python manage.py shell --settings=test_proj.settings_debug
      env:
        DJANGO_SUPERUSER_USERNAME: testuser
        DJANGO_SUPERUSER_PASSWORD: testpassword123

    - name: Start Django development server with debug logging
      run: |
        # Start Django server in background with debug logging
        echo "Starting Django server with debug logging..."
        python manage.py runserver 0.0.0.0:8000 --settings=test_proj.settings_debug > ../django_server.log 2>&1 &
        echo $! > django_server.pid
        echo "Django server started with PID $(cat django_server.pid)"
        
        # Wait for Django to start up
        echo "Waiting for Django server to be ready..."
        for i in {1..30}; do
          if curl -f http://127.0.0.1:8000/admin/login/ > /dev/null 2>&1; then
            echo "Django server is ready!"
            break
          fi
          echo "Attempt $i: Django server not ready yet, waiting..."
          sleep 2
        done
        
        # Final check
        if ! curl -f http://127.0.0.1:8000/admin/login/ > /dev/null 2>&1; then
          echo "ERROR: Django server failed to start properly"
          echo "=== Django Server Log ==="
          cat ../django_server.log || echo "No server log found"
          echo "=== Django Debug Log ==="
          cat ../django_debug.log || echo "No debug log found"
          cat django_server.pid
          ps aux | grep manage.py
          exit 1
        fi

    - name: Create enhanced screenshot and video script for guest user demo
      run: |
        cat > take_screenshots_and_videos.py << 'EOF'
        #!/usr/bin/env python3
        import os
        import sys
        import logging
        import time
        from datetime import datetime
        from playwright.sync_api import sync_playwright

        # Set up logging for the screenshot script
        logging.basicConfig(
            level=logging.DEBUG,
            format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
            handlers=[
                logging.FileHandler('screenshot_process.log'),
                logging.StreamHandler()
            ]
        )

        logger = logging.getLogger('screenshot_script')

        # Define the base URL for your running Django project
        BASE_URL = os.environ.get('BASE_URL', 'http://127.0.0.1:8000')

        # List of URLs to screenshot and record (relative to BASE_URL)
        URLS_TO_CAPTURE = [
            {
                'path': '/',
                'name': 'home_page',
                'description': 'Root URL - Guest user landing page'
            },
            {
                'path': '/admin/',
                'name': 'admin_login',
                'description': 'Django admin login page'
            },
            {
                'path': '/admin/',
                'name': 'admin_dashboard',
                'description': 'Django admin dashboard (after login)',
                'requires_login': True
            },
        ]

        OUTPUT_DIR = 'screenshots'
        VIDEO_DIR = 'videos'

        def setup_output_directories():
            """Create output directories for screenshots and videos."""
            for directory in [OUTPUT_DIR, VIDEO_DIR]:
                if not os.path.exists(directory):
                    os.makedirs(directory)
                    logger.info(f"Created directory: {directory}")

        def login_to_admin_if_needed(page, username, password):
            """
            Logs into the Django admin if credentials are provided.
            """
            if username and password:
                logger.info("Attempting to log into Django admin...")
                try:
                    page.goto(f"{BASE_URL}/admin/login/")
                    
                    # Wait for login form to be visible
                    page.wait_for_selector('input[name="username"]', timeout=10000)
                    
                    # Add some delay for video recording
                    page.wait_for_timeout(1000)
                    
                    logger.info("Filling in login credentials...")
                    page.fill('input[name="username"]', username)
                    page.wait_for_timeout(500)
                    page.fill('input[name="password"]', password)
                    page.wait_for_timeout(500)
                    
                    logger.info("Submitting login form...")
                    page.click('input[type="submit"]')

                    # Wait for successful login - look for admin index page elements
                    try:
                        page.wait_for_selector('h1:has-text("Django administration")', timeout=10000)
                        logger.info("Admin login successful!")
                        page.wait_for_timeout(2000)  # Wait for page to fully load
                        return True
                    except:
                        # If we don't see the admin header, check if we're still on login page
                        if 'login' in page.url:
                            logger.error("Login failed - still on login page")
                            return False
                        else:
                            logger.info("Login appears successful (redirected away from login)")
                            page.wait_for_timeout(2000)
                            return True
                            
                except Exception as e:
                    logger.error(f"Admin login failed: {e}")
                    return False
            return False

        def capture_page_with_video(context, url_info, admin_logged_in=False):
            """
            Capture both screenshot and video of a page interaction.
            """
            url_path = url_info['path']
            page_name = url_info['name']
            description = url_info['description']
            requires_login = url_info.get('requires_login', False)
            
            full_url = f"{BASE_URL}{url_path}"
            
            # Skip pages that require login if we're not logged in
            if requires_login and not admin_logged_in:
                logger.info(f"Skipping {page_name} - requires admin login but not available")
                return False
            
            try:
                logger.info(f"Capturing {page_name}: {description}")
                
                # Create a new page for this capture session
                page = context.new_page()
                
                # Start video recording for this page
                video_path = os.path.join(VIDEO_DIR, f"{page_name}.webm")
                
                logger.info(f"Starting video recording: {video_path}")
                
                # Navigate to the URL
                logger.info(f"Navigating to {full_url}...")
                page.goto(full_url, wait_until='domcontentloaded', timeout=30000)
                
                # Wait for content to load
                page.wait_for_timeout(3000)
                
                # For admin pages, wait for Django admin CSS to load
                if '/admin/' in url_path:
                    try:
                        page.wait_for_selector('.breadcrumbs, #header, .module, #content', timeout=5000)
                        logger.info("Admin page elements loaded")
                    except:
                        logger.warning("Some admin elements didn't load, continuing anyway")
                
                # Demonstrate user interactions based on the page
                if page_name == 'home_page':
                    demonstrate_guest_user_homepage(page)
                elif page_name == 'admin_dashboard' and admin_logged_in:
                    demonstrate_admin_dashboard(page)
                elif page_name == 'admin_login':
                    demonstrate_login_page(page)
                
                # Take screenshot
                screenshot_path = os.path.join(OUTPUT_DIR, f"{page_name}.png")
                page.screenshot(path=screenshot_path, full_page=True)
                logger.info(f"Screenshot saved: {screenshot_path}")
                
                # Wait a bit more for video
                page.wait_for_timeout(2000)
                
                # Close the page (this will stop the video recording)
                page.close()
                
                # Video should be automatically saved by Playwright
                if os.path.exists(video_path):
                    logger.info(f"Video saved: {video_path}")
                else:
                    # Video might be saved with a different name, let's check the videos directory
                    video_files = [f for f in os.listdir(VIDEO_DIR) if f.endswith('.webm')]
                    if video_files:
                        latest_video = max([os.path.join(VIDEO_DIR, f) for f in video_files], key=os.path.getctime)
                        logger.info(f"Video may have been saved as: {latest_video}")
                
                return True
                
            except Exception as e:
                logger.error(f"Failed to capture {page_name}: {e}")
                return False

        def demonstrate_guest_user_homepage(page):
            """
            Demonstrate guest user functionality on the homepage.
            """
            try:
                logger.info("Demonstrating guest user homepage functionality...")
                
                # Look for any guest user related elements
                guest_elements = page.query_selector_all('[class*="guest"], [id*="guest"], [data-guest]')
                if guest_elements:
                    logger.info(f"Found {len(guest_elements)} guest-related elements")
                    # Click on the first guest element if it's clickable
                    for element in guest_elements[:2]:  # Try first 2 elements
                        try:
                            if element.is_visible():
                                element.click()
                                page.wait_for_timeout(1000)
                                break
                        except:
                            continue
                else:
                    logger.info("No obvious guest user elements found")
                    # Scroll around to show the page content
                    page.evaluate("window.scrollTo(0, document.body.scrollHeight / 2)")
                    page.wait_for_timeout(1000)
                    page.evaluate("window.scrollTo(0, 0)")
                    page.wait_for_timeout(1000)
                
            except Exception as e:
                logger.warning(f"Error demonstrating homepage: {e}")

        def demonstrate_login_page(page):
            """
            Demonstrate the admin login page (without actually logging in for this demo).
            """
            try:
                logger.info("Demonstrating admin login page...")
                
                # Focus on username field
                username_field = page.query_selector('input[name="username"]')
                if username_field:
                    username_field.focus()
                    page.wait_for_timeout(1000)
                    
                # Focus on password field
                password_field = page.query_selector('input[name="password"]')
                if password_field:
                    password_field.focus()
                    page.wait_for_timeout(1000)
                
                # Don't actually submit, just demonstrate the interface
                logger.info("Login page demonstration completed")
                
            except Exception as e:
                logger.warning(f"Error demonstrating login page: {e}")

        def demonstrate_admin_dashboard(page):
            """
            Demonstrate the admin dashboard functionality.
            """
            try:
                logger.info("Demonstrating admin dashboard...")
                
                # Look for auth/user management links
                user_links = page.query_selector_all('a[href*="auth"], a[href*="user"]')
                if user_links:
                    logger.info(f"Found {len(user_links)} user management links")
                    # Click on the first user-related link
                    for link in user_links[:1]:
                        try:
                            if link.is_visible():
                                logger.info(f"Clicking on: {link.text_content()}")
                                link.click()
                                page.wait_for_timeout(2000)
                                
                                # Go back to dashboard
                                page.go_back()
                                page.wait_for_timeout(1000)
                                break
                        except:
                            continue
                
                # Look for any guest user related admin sections
                guest_links = page.query_selector_all('a[href*="guest"], [class*="guest"]')
                if guest_links:
                    logger.info(f"Found {len(guest_links)} guest user admin links")
                    for link in guest_links[:1]:
                        try:
                            if link.is_visible():
                                logger.info(f"Clicking on guest user link: {link.text_content()}")
                                link.click()
                                page.wait_for_timeout(2000)
                                page.go_back()
                                page.wait_for_timeout(1000)
                                break
                        except:
                            continue
                
                logger.info("Admin dashboard demonstration completed")
                
            except Exception as e:
                logger.warning(f"Error demonstrating admin dashboard: {e}")

        def main():
            setup_output_directories()

            # Get credentials from environment variables
            DJANGO_SUPERUSER_USERNAME = os.environ.get('DJANGO_SUPERUSER_USERNAME')
            DJANGO_SUPERUSER_PASSWORD = os.environ.get('DJANGO_SUPERUSER_PASSWORD')

            logger.info(f"Starting screenshot and video capture at {datetime.now()}")
            logger.info(f"Base URL: {BASE_URL}")
            logger.info(f"Output directories: {OUTPUT_DIR}, {VIDEO_DIR}")

            with sync_playwright() as p:
                # Launch browser with video recording enabled
                browser = p.chromium.launch(
                    args=['--no-sandbox', '--disable-dev-shm-usage']  # Useful for CI environments
                )
                
                # Create browser context with video recording
                context = browser.new_context(
                    viewport={'width': 1920, 'height': 1080},
                    record_video_dir=VIDEO_DIR,
                    record_video_size={'width': 1920, 'height': 1080}
                )
                
                # Create a page for admin login
                login_page = context.new_page()
                
                # Perform admin login if credentials are provided
                admin_logged_in = login_to_admin_if_needed(login_page, DJANGO_SUPERUSER_USERNAME, DJANGO_SUPERUSER_PASSWORD)
                
                # Close the login page
                login_page.close()
                
                capture_results = []
                
                # Capture each URL with video recording
                for url_info in URLS_TO_CAPTURE:
                    success = capture_page_with_video(context, url_info, admin_logged_in)
                    capture_results.append({
                        'name': url_info['name'],
                        'description': url_info['description'],
                        'success': success
                    })

                # Close browser context and browser
                context.close()
                browser.close()
                
                # Print summary
                logger.info("\n" + "="*60)
                logger.info("CAPTURE SUMMARY")
                logger.info("="*60)
                successful = sum(1 for r in capture_results if r['success'])
                total = len(capture_results)
                logger.info(f"Successfully captured: {successful}/{total} pages")
                
                for result in capture_results:
                    status = "✓" if result['success'] else "✗"
                    logger.info(f"{status} {result['name']}: {result['description']}")
                
                # List generated files
                logger.info("\n" + "="*60)
                logger.info("GENERATED FILES")
                logger.info("="*60)
                
                screenshot_files = [f for f in os.listdir(OUTPUT_DIR) if f.endswith('.png')] if os.path.exists(OUTPUT_DIR) else []
                video_files = [f for f in os.listdir(VIDEO_DIR) if f.endswith('.webm')] if os.path.exists(VIDEO_DIR) else []
                
                logger.info(f"Screenshots ({len(screenshot_files)}):")
                for f in sorted(screenshot_files):
                    logger.info(f"  📸 {f}")
                
                logger.info(f"Videos ({len(video_files)}):")
                for f in sorted(video_files):
                    logger.info(f"  🎥 {f}")
                
                if successful == 0:
                    logger.error("\nWARNING: No pages were captured successfully!")
                    sys.exit(1)
                elif successful < total:
                    logger.warning(f"\nWARNING: {total - successful} pages failed to capture")
                else:
                    logger.info(f"\n🎉 All pages captured successfully!")

        if __name__ == '__main__':
            main()
        EOF

    - name: Take screenshots and videos with guest user demonstration
      run: |
        echo "=== Starting screenshot and video capture with guest user demonstration ==="
        python take_screenshots_and_videos.py
      env:
        DJANGO_SUPERUSER_USERNAME: testuser
        DJANGO_SUPERUSER_PASSWORD: testpassword123
        BASE_URL: http://127.0.0.1:8000

    - name: Collect all log files
      if: always()
      run: |
        echo "=== Collecting log files ==="
        mkdir -p logs
        
        # Copy Django debug log
        if [ -f django_debug.log ]; then
          cp django_debug.log logs/django_debug.log
          echo "Django debug log copied"
        else
          echo "No Django debug log found"
        fi
        
        # Copy Django server log
        if [ -f django_server.log ]; then
          cp django_server.log logs/django_server.log
          echo "Django server log copied"
        else
          echo "No Django server log found"
        fi
        
        # Copy screenshot process log
        if [ -f screenshot_process.log ]; then
          cp screenshot_process.log logs/screenshot_process.log
          echo "Screenshot process log copied"
        else
          echo "No screenshot process log found"
        fi
        
        # Create a summary log
        cat > logs/summary.log << EOF
        Django Guest User Example Test Summary
        ======================================
        Timestamp: $(date)
        Django Settings: test_proj.settings_debug
        Base URL: $BASE_URL
        Debug Mode: $DEBUG
        Django Log Level: $DJANGO_LOG_LEVEL
        
        Test Focus: Django Guest User functionality demonstration
        Features Tested: Guest user creation, authentication, and management
        Visual Documentation: Screenshots and videos of user interactions
        
        Screenshots Generated:
        $(find screenshots -name "*.png" 2>/dev/null | sort || echo "No screenshots found")
        
        Videos Generated:
        $(find videos -name "*.webm" 2>/dev/null | sort || echo "No videos found")
        
        Log Files:
        $(find logs -name "*.log" 2>/dev/null | sort || echo "No log files found")
        EOF
        
        echo "All log files collected in logs/ directory"
        ls -la logs/ || echo "No logs directory found"

    - name: Upload screenshots as artifact
      uses: actions/upload-artifact@v4
      if: always()  # Upload even if capture step fails
      with:
        name: django-guest-user-screenshots
        path: screenshots/
        retention-days: 30

    - name: Upload videos as artifact
      uses: actions/upload-artifact@v4
      if: always()  # Upload even if capture step fails
      with:
        name: django-guest-user-videos
        path: videos/
        retention-days: 30

    - name: Upload debug logs as artifact
      uses: actions/upload-artifact@v4
      if: always()  # Upload even if previous steps fail
      with:
        name: django-debug-logs
        path: logs/
        retention-days: 30

    - name: Display capture summary
      if: always()
      run: |
        echo "=== CAPTURE SUMMARY ==="
        if [ -f logs/summary.log ]; then
         cat logs/summary.log
        fi
        
        echo ""
        echo "=== SCREENSHOT FILES ==="
        if [ -d screenshots ]; then
          ls -la screenshots/
        else
          echo "No screenshots directory found"
        fi
        
        echo ""
        echo "=== VIDEO FILES ==="
        if [ -d videos ]; then
          ls -la videos/
        else
          echo "No videos directory found"
        fi
        
        echo ""
        echo "=== LOG FILES ==="
        if [ -d logs ]; then
          ls -la logs/
        else
          echo "No logs directory found"
        fi

    - name: Stop Django server
      if: always()
      run: |
        if [ -f django_server.pid ]; then
          kill $(cat django_server.pid) || true
          rm django_server.pid
        fi
